<html lang="en"><head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="../css/globals.css">
  <link rel="stylesheet" href="../css/text.css">
  <link rel="stylesheet" href="../css/gui-button.css">
  <link rel="stylesheet" href="../css/menu.css">

  <title>Isaah Hideout</title>
  <style>
    body {
      display: flex;
      min-height: 100vh;
      flex-direction: column;
    }
    .wrapper {
      display: flex;
      flex: 1;
    }
    .sidebar {
      width: 250px;
      background: #343a40;
      color: #fff;
      padding: 15px;
    }
    .sidebar a {
      color: #fff;
      text-decoration: none;
      display: block;
      padding: 10px;
      margin-bottom: 5px;
      transition: background 0.3s;
    }
    .sidebar a:hover {
      background: #495057;
    }
    .main-content {
      flex: 1;
      padding: 20px;
    }
    .card {
      margin-bottom: 20px;
    }
    .card img {
      max-width: 100px;
    }
    .reports {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-top: 20px;
    }
    .report-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <nav class="sidebar">
      <h2>Menu</h2>
      <a href="/gui/inventory">Inventory</a>
      <a href="/gui/transaction">Transaction</a>
      <a href="/gui/visual">Data Visualization</a>
    </nav>
    <div class="main-content">
      <div class="container">
        <div class="row">
          <div class="col-md-4">
            <div class="card text-center">
              <div class="card-body">
                <img src="../img/inventory.svg" alt="Inventory">
                <h2>Inventory</h2>
                <p>
                  Manage your remaining products &amp; items here.
                  Represent your inventory by tallying product quantities.
                  Shows status of inventory like item quantity.
                </p>
                <a href="/gui/inventory" class="btn btn-primary">Go to Inventory</a>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card text-center">
              <div class="card-body">
                <img src="../img/transactions.svg" alt="Transaction">
                <h2>Transaction</h2>
                <p>
                  Record products during sales.
                  Automatically update your inventory.
                  This feature also offers basic calculations during transactions.
                </p>
                <a href="/gui/transaction" class="btn btn-primary">Go to Transaction</a>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card text-center">
              <div class="card-body">
                <img src="../img/data-visual.svg" alt="Data Visualization">
                <h2>Data Visualization</h2>
                <p>
                  Visualize your data with graphical charts.
                  Gives visual insights to your sales.
                </p>
                <a href="/gui/visual" class="btn btn-primary">Go to Data Visualization</a>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row mt-5">
          <div class="col-12">
            <div class="form-group">
              <label for="start">Start Date:</label>
              <input type="date" id="start" class="form-control">
            </div>
            <div class="form-group">
              <label for="end">End Date:</label>
              <input type="date" id="end" class="form-control">
            </div>
            <button class="btn btn-success gn">Generate Reports</button>
          </div>
        </div>
        
        <div class="reports border-purp">
          <!-- Reports will be generated here -->
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // -------------------- GLOBALS -------------------
    const StartDate = new Date('2022-01-01').toISOString().split('T')[0];
    const EndDate = new Date('2024-05-01').toISOString().split('T')[0];
    const Reports = document.querySelector('.reports');


    // -------------------- EVENTS -------------------
    document.querySelector('.gn').addEventListener('click', async function() {
        const data = await GetTimeFrameData(StartDate.value, EndDate.value);
        await GenerateReports(data);
        var element = document.querySelector('.border-purp');
        if (!element.classList.contains('active')) {
            element.classList.add('active');
        }
    });

    // -------------------- FUNCTIONS -------------------
    async function GetTimeFrameData (StartDate, EndDate) {
      const response = await fetch(`/data/transactions/${StartDate}/${EndDate}`)
      const data = await response.json()
      return data
    }

    function PrintLine (canvas, labels, values, name = 'n/a', LineColor = 'rgb(75, 192, 192)') {
      const LineChart = new Chart(canvas, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: name,
            data: values,
            fill: false,
            borderColor: LineColor,
            tension: 0.1
          }]
        }
      })
      return LineChart
    }

    function PrintPie (canvas, products, quantities, title = 'N/A') {
      let sum = 0
      for (let i = 0; i < quantities.length; ++i) {
        sum += quantities[i]
      }

      const ProductLabelWithPercentage = []
      for (let i = 0; i < products.length; ++i) {
        const LabeWithPercentage = parseFloat(`${quantities[i] / sum * 100}`).toFixed(2)
        ProductLabelWithPercentage.push(
          `${products[i]} ${LabeWithPercentage}%`
        )
      }

      const PieChart = new Chart(canvas, {
        type: 'pie',
        data: {
          labels: ProductLabelWithPercentage,
          datasets: [{
            data: quantities,
            backgroundColor: [
              'rgb(255, 99, 132)',
              'rgb(54, 162, 235)',
              'rgb(255, 205, 86)',
              'rgb(98, 224, 82)',
              'rgb(230, 115, 230)',
              'rgb(169, 115, 230)',
              'rgb(115, 226, 230)',
              'rgb(66, 160, 47)'
            ],
            hoverOffset: 20
          }]
        },
        options: {
          plugins: {
            title: {
              display: true,
              text: title
            },
            legend: {
              display: true
            }
          },
          responsive: true,
          maintainAspectRatio: false,
          borderWidth: 0.4
        }
      })
      return PieChart
    }

    async function GenerateReports (data) {
      Reports.innerHTML = ''

      // Iterate Through Data
      const PieOrganize = {}
      const LineDataValues = {}

      for (let i = 0; i < data.length; ++i) {
        // pie chart data extraction
        if (typeof PieOrganize[data[i].itemname] === 'undefined') {
          PieOrganize[data[i].itemname] = {
            itemname: data[i].itemname,
            price: data[i].price,
            quantity: data[i].quantity
          }
        } else {
          PieOrganize[data[i].itemname].quantity += data[i].quantity
        }

        // line chart data extraction
        if (typeof LineDataValues[formatDateYearMonthDay(data[i].buydate)] === 'undefined') {
          LineDataValues[formatDateYearMonthDay(data[i].buydate)] = {
            totalAmount: data[i].price * data[i].quantity,
            totalQuantity: data[i].quantity
          }
        } else {
          LineDataValues[formatDateYearMonthDay(data[i].buydate)].totalAmount += data[i].price * data[i].quantity
          LineDataValues[formatDateYearMonthDay(data[i].buydate)].totalQuantity += data[i].quantity
        }
      }

      // Calculate Pie Charts Data
      const products = []
      const quantity = []
      const totalAmount = []

      for (const [, value] of Object.entries(PieOrganize)) {
        products.push(value.itemname)
        quantity.push(value.quantity)
        totalAmount.push(value.quantity * value.price)
      }

      // Calculate Line Charts Data
      const DatesBetween = getDates(
        new Date(StartDate.value),
        new Date(EndDate.value)
      )

      const LineAmountParsedValues = []
      const LineQuantityParsedValues = []

      for (let i = 0; i < DatesBetween.length; ++i) {
        if (typeof LineDataValues[DatesBetween[i]] === 'undefined') {
          LineAmountParsedValues.push(0)
          LineQuantityParsedValues.push(0)
        } else {
          LineAmountParsedValues.push(LineDataValues[DatesBetween[i]].totalAmount)
          LineQuantityParsedValues.push(LineDataValues[DatesBetween[i]].totalQuantity)
        }
      }

      // Add to html
      const CanvasQuantity = document.createElement('canvas')
      const CanvasTotals = document.createElement('canvas')
      const CanvasLineDayAmount = document.createElement('canvas')
      const CanvasLineDayQuantity = document.createElement('canvas')

      const PieContainerQuantity = document.createElement('div')
      const PieContainerAmount = document.createElement('div')
      const LineContainerAmount = document.createElement('div')
      const LineContainerQuantity = document.createElement('div')

      const PieTextQuantity = document.createElement('h2')
      const PieTextAmount = document.createElement('h2')
      const LineTextAmount = document.createElement('h2')
      const LineTextQuantity = document.createElement('h2')

      let MinQtySold = quantity[0]
      let MinQtySoldProduct = products[0]
      let MaxQtySold = quantity[0]
      let MaxQtySoldProduct = products[0]

      let MinRevenueSold = totalAmount[0]
      let MinRevenueSoldProduct = products[0]
      let MaxRevenueSold = totalAmount[0]
      let MaxRevenueSoldProduct = products[0]

      for (let i = 0; i < products.length; ++i) {
        if (quantity[i] < MinQtySold) {
          MinQtySold = quantity[i]
          MinQtySoldProduct = products[i]
        }

        if (quantity[i] > MaxQtySold) {
          MaxQtySold = quantity[i]
          MaxQtySoldProduct = products[i]
        }

        if (totalAmount[i] < MinRevenueSold) {
          MinRevenueSold = totalAmount[i]
          MinRevenueSoldProduct = products[i]
        }

        if (totalAmount[i] > MaxRevenueSold) {
          MaxRevenueSold = totalAmount[i]
          MaxRevenueSoldProduct = products[i]
        }
      }

      const SummaryMsg = document.createElement('div')

      PieTextQuantity.innerText = 'Sold Items Quantity Ratio'
      PieTextAmount.innerText = 'Sold Items Revenue Ratio'
      LineTextAmount.innerText = 'Amount Daily Totals'
      LineTextQuantity.innerText = 'Quantity Daily Totals'
      SummaryMsg.innerHTML =
        `<br><br>
        <h1>Sold Quantities</h2>
        <p>The most sold product in quantity is ${MaxQtySoldProduct},
        there are a total of ${MaxQtySold}x ${MaxQtySoldProduct} sold during the time period specified.</p>
        
        <p>On The other hand, the least sold product in quantity is ${MinQtySoldProduct},
        there are only a total of ${MinQtySold}x ${MinQtySoldProduct} sold during the time period specified.</p>
        
        <h1>Product Revenues</h2>
        <p>The product that have the biggest revenue is ${MaxRevenueSoldProduct}, during the time period specified
        ${MaxRevenueSoldProduct} sold a total of ₱${MaxRevenueSold}.</p>
        
        <p>On the other hand, The product that have the smallest revenue is ${MinRevenueSoldProduct}, during the time period specified
        ${MinRevenueSoldProduct} sold only a total of ₱${MinRevenueSold}.</p>`

      SummaryMsg.style.display = 'flex'
      SummaryMsg.style.flexDirection = 'column'
      SummaryMsg.style.gap = '0.8em'
      SummaryMsg.style.padding = '1em'

      PieContainerQuantity.appendChild(CanvasQuantity)
      PieContainerAmount.appendChild(CanvasTotals)
      LineContainerAmount.appendChild(CanvasLineDayAmount)
      LineContainerQuantity.appendChild(CanvasLineDayQuantity)

      PrintPie(CanvasQuantity, products, quantity, 'Sold Quantity Ratio')
      PrintPie(CanvasTotals, products, totalAmount, 'Sales Revenue Ratio')
      PrintLine(CanvasLineDayAmount, DatesBetween, LineAmountParsedValues, 'Daily Revenue', 'rgb(225,86,96)')
      PrintLine(CanvasLineDayQuantity, DatesBetween, LineQuantityParsedValues, 'Daily Sold Quantity', 'rgb(109,255,67)')

      Reports.appendChild(PieTextQuantity)
      Reports.appendChild(PieContainerQuantity)

      Reports.appendChild(PieTextAmount)
      Reports.appendChild(PieContainerAmount)

      Reports.appendChild(LineTextAmount)
      Reports.appendChild(LineContainerAmount)

      Reports.appendChild(LineTextQuantity)
      Reports.appendChild(LineContainerQuantity)

      Reports.appendChild(SummaryMsg)
    }

    function getDates (start, end) {
      const dates = []
      while (start.getTime() <= end.getTime()) {
        const month = ('0' + (start.getMonth() + 1)).slice(-2)
        const day = ('0' + start.getDate()).slice(-2)
        const date = [start.getFullYear(), month, day].join('-')
        dates.push(date)
        start.setDate(start.getDate() + 1)
      }
      return dates
    }

    function formatDateYearMonthDay (date) {
      const d = new Date(date)
      const year = d.getFullYear()
      let month = '' + (d.getMonth() + 1)
      let day = '' + d.getDate()

      if (month.length < 2) month = '0' + month
      if (day.length < 2) day = '0' + day

      return [year, month, day].join('-')
    }
  </script>



</body></html>
